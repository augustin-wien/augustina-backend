on:
  push:
    branches:
    - master
    - main
  pull_request:
name: tester
jobs:
  Gotest:
    runs-on: ubuntu-latest

    env:
      # Note: this sets the main database also as the test database
      DB_USER: user
      DB_PASS: password
      DB_HOST: localhost
      DB_HOST_TEST: localhost # default host value for the database
      DB_NAME: djtesting
      DB_PORT: 5432

    services:
      # start a postgres service container
      postgres_main:
        image: postgres:16
        env:
          POSTGRES_USER: "user"
          POSTGRES_PASSWORD: "password"
          POSTGRES_DB: "djtesting"
        ports:
        - 5432:5432
        # wait until postgres is ready
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Load .env into GitHub Actions environment
      shell: bash
      run: |
        if [ ! -f .env.example ]; then
          echo ".env.example not found in repository root" >&2
          exit 1
        fi

        # Normalize line endings to LF in a temp file, then read it
        TMP_ENV=$(mktemp)
        tr -d '\r' < .env.example > "$TMP_ENV"

        # Export environment for this step so we can validate
        set -o allexport
        # shellcheck disable=SC1090
        source "$TMP_ENV"
        set +o allexport

        # Persist parsed variables to $GITHUB_ENV for subsequent steps
        # Ignore comments and blank lines, trim surrounding quotes from values
        grep -v '^[[:space:]]*#' "$TMP_ENV" | sed '/^[[:space:]]*$/d' | while IFS='=' read -r name value; do
          # Skip lines that don't contain '='
          if [ -z "$name" ] || [ -z "${value+set}" ]; then
            continue
          fi
          # Trim leading and trailing whitespace from name
          name=$(echo "$name" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          # Remove surrounding single or double quotes
          value="${value%\"}"; value="${value#\"}"
          value="${value%\'}"; value="${value#\'}"
          echo "$name=$value" >> $GITHUB_ENV
        done

        rm -f "$TMP_ENV"

    - name: Validate DB environment variables
      shell: bash
      run: |
        # Set safe defaults if missing
        : "${POSTGRES_USER:=postgres}"
        : "${POSTGRES_DB:=postgres}"
        : "${POSTGRES_PORT:=5432}"

        # Ensure POSTGRES_PORT is digits only
        if ! printf '%s' "$POSTGRES_PORT" | grep -qE '^[0-9]+$'; then
          echo "POSTGRES_PORT must be a number, got: '$POSTGRES_PORT'" >&2
          exit 1
        fi

        # Persist defaults back to $GITHUB_ENV
        echo "POSTGRES_USER=$POSTGRES_USER" >> $GITHUB_ENV
        echo "POSTGRES_DB=$POSTGRES_DB" >> $GITHUB_ENV
        echo "POSTGRES_PORT=$POSTGRES_PORT" >> $GITHUB_ENV

        # Do not print secrets; print only non-sensitive keys
        echo "POSTGRES_USER=$POSTGRES_USER"
        echo "POSTGRES_PORT=$POSTGRES_PORT"

    - name: Dump DB-related env keys (non-secret)
      run: |
        env | sort | grep -E 'POSTGRES|DB_|PG' || true

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USER }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: set env
      run: |
        cp .env.example .env || true
        # Copy env for docker-compose if present so services pick up same values
        if [ -d docker ]; then
          cp .env.example docker/.env || true
        fi
      # /home/runner/work/augustina-backend/augustin-backend/docker/.env.parser

    - name: Build keycloak image
      run: docker compose up -d keycloak

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: "1.22"
        cache-dependency-path: app/go.sum
    
    - name: Wait for Postgres to be reachable
      run: |
        echo "Waiting for Postgres on localhost:5432..."
        for i in {1..30}; do
          if nc -z localhost 5432; then
            echo "Postgres is reachable"
            exit 0
          fi
          sleep 2
        done
        echo "Postgres did not become reachable" 1>&2
        exit 1

    - name: Build
      run: go install github.com/jackc/tern/v2@latest && cd app && go build -o ../build/
    - name: Wait for keycloak to start
      run: |
        while ! curl --connect-timeout 5 -v --max-time 10 --retry 5 --retry-connrefused  --retry-delay 0 --retry-max-time 40 http://localhost:8080
        do
            { echo "Exit status of curl: $?"
              echo "Retrying ..."
            } 1>&2
            sleep 10
        done

    - name: Test
      run: |
        echo "Running tests ..."
        echo "copying env file ..."
        cp .env.example ./app/.env
        ./scripts/env_test.sh
        cd app
        cd migrations

        # Remove the migration file to be excluded
        rm 011_trigger_add_prevent_dropping_and_deleting.sql 
        # Create a dummy table for migration 11 so the following migrations can run
        echo "CREATE TABLE Dummy (ID SERIAL PRIMARY KEY);" > 011_sample_dummy_table.sql
        echo "Run migrations ..."
        ls -lah
        # Run the migrations
        echo "Checking for empty values in migration config ..."
        grep -nE '=[[:space:]]*$|=[[:space:]]*""[[:space:]]*$|:[[:space:]]*$' ./tern_test.conf || true
        tern migrate --config ./tern_test.conf
        echo "Migrations applied."
        echo "Running tests ..."
        # Run the tests
        cd .. 
        go test ./... -p 1 -v -cover

    - name: Collect docker logs on failure
      if: failure()
      uses: jwalton/gh-docker-logs@v1
      with:
        dest: "./logs"
    - name: Tar logs
      if: failure()
      run: tar cvzf ./logs.tgz ./logs
    - name: Upload logs to GitHub
      if: failure()
      uses: actions/upload-artifact@master
      with:
        name: logs.tgz
        path: ./logs.tgz
